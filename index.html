<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPT-4o System Prompt Testing Lab</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css');

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .response-card {
            min-height: 200px;
            border-left: 4px solid #3b82f6;
        }

        .response-card.error {
            border-left-color: #ef4444;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .module-panel {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .module-panel.collapsed .module-content {
            display: none;
        }

        .module-header {
            background: #f9fafb;
            border-radius: 0.5rem 0.5rem 0 0;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
        }

        .module-panel.collapsed .module-header {
            border-radius: 0.5rem;
            border-bottom: none;
        }

        .drag-handle {
            cursor: grab;
            color: #9ca3af;
        }

        .drag-handle:hover {
            color: #6b7280;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .module-toggle {
            cursor: pointer;
        }

        .module-toggle input[type="checkbox"] {
            cursor: pointer;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold">🧪 GPT-4o System Prompt Testing Lab</h1>
                <div class="flex space-x-4">
                    <button onclick="showTab('testing')" id="testing-tab"
                        class="px-4 py-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-colors">
                        Testing
                    </button>
                    <button onclick="showTab('management')" id="management-tab"
                        class="px-4 py-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-colors">
                        Prompt Management
                    </button>
                    <button onclick="showTab('history')" id="history-tab"
                        class="px-4 py-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-colors">
                        Test History
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Testing Tab -->
        <div id="testing-panel" class="tab-panel">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Input Panel -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-lg p-6 sticky top-8">
                        <h2 class="text-xl font-semibold mb-4">Test Configuration</h2>

                        <!-- Quick Message (Optional) -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quick Message (Optional)</label>
                            <textarea id="user-prompt" rows="4"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Enter a message to send quickly..."></textarea>
                        </div>

                        <!-- System Prompt Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">System Prompt</label>
                            <select id="selected-prompt" onchange="loadPromptModules()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select a system prompt...</option>
                            </select>
                        </div>

                        <!-- Module Selection -->
                        <div id="module-selection" class="mb-4 hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Active Modules</label>
                            <div id="module-toggles"
                                class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-md p-3">
                                <!-- Module toggles will be populated here -->
                            </div>
                        </div>

                        <!-- Parameters -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Temperature</label>
                            <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" class="w-full">
                            <span class="text-sm text-gray-500" id="temperature-value">0.7</span>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Max Tokens</label>
                            <input type="number" id="max-tokens" value="1024" min="1" max="4096"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Seed (optional)</label>
                            <input type="number" id="seed" placeholder="Leave blank for random"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <button id="test-btn" onclick="sendMessage()"
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                            Send Message
                        </button>
                        <button id="clear-conversation-btn" onclick="clearConversation()"
                            class="w-full mt-2 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                            Clear Conversation
                        </button>
                    </div>
                </div>

                <!-- Conversation Panel -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="border-b border-gray-200 p-4">
                            <h3 class="text-lg font-semibold">Conversation</h3>
                        </div>
                        <div id="conversation-container" class="h-96 overflow-y-auto p-4 space-y-4">
                            <div class="text-center text-gray-500 py-12">
                                <div class="text-6xl mb-4">💬</div>
                                <p>Select a system prompt and start a conversation</p>
                            </div>
                        </div>
                        <div class="border-t border-gray-200 p-4">
                            <div class="flex space-x-2">
                                <input type="text" id="conversation-input" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                       placeholder="Type your message..." 
                                       onkeypress="if(event.key==='Enter') sendMessage()">
                                <button onclick="sendMessage()" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Management Tab -->
        <div id="management-panel" class="tab-panel hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Create/Edit Form -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">Create/Edit System Prompt</h2>

                    <form id="prompt-form" onsubmit="savePrompt(event)">
                        <input type="hidden" id="edit-prompt-id">

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ID*</label>
                            <input type="text" id="prompt-id" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="unique-prompt-id">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Name*</label>
                            <input type="text" id="prompt-name" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Descriptive name">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <input type="text" id="prompt-description"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Brief description of this prompt">
                        </div>

                        <!-- Module Editor -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-3">
                                <label class="text-sm font-medium text-gray-700">Modules*</label>
                                <button type="button" onclick="addModule()"
                                    class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                                    + Add Module
                                </button>
                            </div>
                            <div id="modules-container" class="space-y-3">
                                <!-- Modules will be added here -->
                            </div>
                        </div>

                        <div class="flex space-x-2">
                            <button type="submit"
                                class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">
                                Save Prompt
                            </button>
                            <button type="button" onclick="clearForm()"
                                class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                Clear
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Existing Prompts -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">Existing System Prompts</h2>
                    <div id="existing-prompts" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Prompts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history-panel" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">Test History</h2>
                    <button onclick="clearHistory()" class="text-red-600 hover:text-red-700 font-medium">
                        Clear History
                    </button>
                </div>
                <div id="history-container" class="space-y-6">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📝</div>
                        <p>No test history yet. Run some tests to see results here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000/api';
        let systemPrompts = {};
        let testHistory = JSON.parse(localStorage.getItem('testHistory') || '[]');
        let currentModules = {};
        let moduleOrder = [];
        let conversationHistory = [];

        // Base modules for fallback
        const BASE_MODULES = {
            DEFAULT: "You are a helpful AI assistant. Provide clear, accurate, and concise responses.",
            RESPONSE_STRUCTURE: "Structure your responses with clear headings and bullet points where appropriate.",
            WELCOME: "Begin interactions with a friendly greeting.",
            GUIDELINES: "Follow ethical guidelines and provide helpful, harmless, and honest responses.",
            CONTEXT_AWARENESS: "Consider the context of the conversation when responding."
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function () {
            loadSystemPrompts();
            setupEventListeners();
            showTab('testing');
            loadHistory();
        });

        function setupEventListeners() {
            document.getElementById('temperature').addEventListener('input', function (e) {
                document.getElementById('temperature-value').textContent = e.target.value;
            });
        }

        async function loadSystemPrompts() {
            try {
                const response = await fetch(`${API_BASE}/system-prompts`);
                if (response.ok) {
                    systemPrompts = await response.json();
                    populatePromptSelect();
                    populateExistingPrompts();
                } else {
                    showError('Failed to load system prompts');
                }
            } catch (error) {
                showError('Error loading system prompts: ' + error.message);
            }
        }

        function populatePromptSelect() {
            const select = document.getElementById('selected-prompt');
            select.innerHTML = '<option value="">Select a system prompt...</option>';

            Object.entries(systemPrompts).forEach(([id, prompt]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${prompt.name} - ${prompt.description || 'No description'}`;
                select.appendChild(option);
            });
        }

        function loadPromptModules() {
            const promptId = document.getElementById('selected-prompt').value;
            const moduleSection = document.getElementById('module-selection');
            const moduleToggles = document.getElementById('module-toggles');

            if (!promptId) {
                moduleSection.classList.add('hidden');
                clearConversation(); // Clear conversation when no prompt is selected
                return;
            }

            const prompt = systemPrompts[promptId];
            if (!prompt) return;

            // Clear conversation when switching prompts
            clearConversation();

            moduleSection.classList.remove('hidden');
            moduleToggles.innerHTML = '';

            const modules = prompt.modules || {};
            const order = prompt.order || Object.keys(modules);

            order.forEach(moduleName => {
                const moduleText = modules[moduleName] || BASE_MODULES[moduleName] || '';
                const div = document.createElement('div');
                div.className = 'flex items-start space-x-2 module-toggle';

                div.innerHTML = `
                    <input type="checkbox" id="module-${moduleName}" value="${moduleName}" 
                           class="mt-1" checked>
                    <label for="module-${moduleName}" class="text-sm cursor-pointer flex-1">
                        <strong>${moduleName}</strong>
                        <div class="text-gray-500 text-xs mt-1 max-h-16 overflow-y-auto">
                            ${moduleText.substring(0, 150)}${moduleText.length > 150 ? '...' : ''}
                        </div>
                    </label>
                `;
                moduleToggles.appendChild(div);
            });
        }

        function populateExistingPrompts() {
            const container = document.getElementById('existing-prompts');
            container.innerHTML = '';

            Object.entries(systemPrompts).forEach(([id, prompt]) => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-3 card-hover';

                const modules = prompt.modules || {};
                const moduleCount = Object.keys(modules).length;

                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-medium">${prompt.name}</h4>
                            <p class="text-sm text-gray-500">ID: ${id}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editPrompt('${id}')" class="text-blue-600 hover:text-blue-700 text-sm">Edit</button>
                            <button onclick="duplicatePrompt('${id}')" class="text-green-600 hover:text-green-700 text-sm">Duplicate</button>
                            ${id !== 'default' ? `<button onclick="deletePrompt('${id}')" class="text-red-600 hover:text-red-700 text-sm">Delete</button>` : ''}
                        </div>
                    </div>
                    ${prompt.description ? `<p class="text-sm text-gray-600 mb-2">${prompt.description}</p>` : ''}
                    <div class="text-xs text-gray-400">
                        <div>${moduleCount} modules: ${(prompt.order || Object.keys(modules)).join(', ')}</div>
                        <div class="text-right mt-1">Created: ${new Date(prompt.created_at || '').toLocaleDateString()}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function sendMessage() {
            const messageInput = document.getElementById('conversation-input');
            const quickMessage = document.getElementById('user-prompt').value.trim();
            const userPrompt = messageInput.value.trim() || quickMessage;
            const promptId = document.getElementById('selected-prompt').value;

            if (!userPrompt) {
                showError('Please enter a message');
                return;
            }

            if (!promptId) {
                showError('Please select a system prompt');
                return;
            }

            // Clear input fields
            messageInput.value = '';
            if (quickMessage) document.getElementById('user-prompt').value = '';

            // Add user message to conversation
            addMessageToConversation('user', userPrompt);

            // Get selected modules
            const selectedModules = Array.from(document.querySelectorAll('#module-toggles input:checked')).map(cb => cb.value);

            const temperature = parseFloat(document.getElementById('temperature').value);
            const maxTokens = parseInt(document.getElementById('max-tokens').value);
            const seed = document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : undefined;

            const options = { temperature, max_tokens: maxTokens };
            if (seed !== undefined) options.seed = seed;

            // Show loading state
            const testBtn = document.getElementById('test-btn');
            const sendBtn = document.querySelector('button[onclick="sendMessage()"]');
            testBtn.innerHTML = '<div class="spinner"></div>Sending...';
            testBtn.disabled = true;
            sendBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userPrompt,
                        promptId,
                        options,
                        conversationHistory
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    addMessageToConversation('assistant', data.text);
                    
                    // Update conversation history
                    conversationHistory.push({ role: 'user', content: userPrompt });
                    conversationHistory.push({ role: 'assistant', content: data.text });
                } else {
                    const error = await response.json();
                    showError('Message failed: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Error sending message: ' + error.message);
            } finally {
                testBtn.innerHTML = 'Send Message';
                testBtn.disabled = false;
                sendBtn.disabled = false;
            }
        }

        function addMessageToConversation(role, content) {
            const container = document.getElementById('conversation-container');
            
            // Clear placeholder if it exists
            if (container.querySelector('.text-center')) {
                container.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                role === 'user' 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-gray-200 text-gray-800'
            }`;
            
            messageBubble.innerHTML = `
                <div class="text-sm font-medium mb-1">${role === 'user' ? 'You' : 'Assistant'}</div>
                <div class="text-sm whitespace-pre-wrap">${content}</div>
            `;
            
            messageDiv.appendChild(messageBubble);
            container.appendChild(messageDiv);
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function clearConversation() {
            conversationHistory = [];
            const container = document.getElementById('conversation-container');
            container.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">💬</div>
                    <p>Select a system prompt and start a conversation</p>
                </div>
            `;
        }

        function displayResults(data) {
            const container = document.getElementById('results-container');
            container.innerHTML = '';

            // Summary
            const summary = document.createElement('div');
            summary.className = 'bg-blue-50 border-l-4 border-blue-400 p-4 mb-6';
            summary.innerHTML = `
                <h3 class="font-medium text-blue-800 mb-2">Test Results Summary</h3>
                <p class="text-blue-700">
                    <strong>User Prompt:</strong> "${data.user_prompt.substring(0, 100)}${data.user_prompt.length > 100 ? '...' : ''}"<br>
                    <strong>Model:</strong> ${data.model}<br>
                    <strong>Tests:</strong> ${data.success_count}/${data.test_count} successful
                </p>
            `;
            container.appendChild(summary);

            // Results grid
            const resultsGrid = document.createElement('div');
            resultsGrid.className = 'comparison-grid';

            Object.entries(data.results).forEach(([promptId, result]) => {
                const card = document.createElement('div');
                card.className = `response-card bg-white rounded-lg shadow-lg p-6 fade-in ${result.error ? 'error' : ''}`;

                if (result.error) {
                    card.innerHTML = `
                        <div class="flex items-center mb-3">
                            <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                            <h3 class="font-semibold text-red-700">${systemPrompts[promptId]?.name || promptId}</h3>
                        </div>
                        <div class="text-red-600 bg-red-50 p-3 rounded">
                            <strong>Error:</strong> ${result.error}
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                <h3 class="font-semibold text-gray-800">${result.system_prompt_name}</h3>
                            </div>
                            <div class="text-xs text-gray-500">
                                ${result.usage?.total_tokens || 0} tokens
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="text-xs text-gray-500 mb-1">System Prompt Preview:</div>
                            <div class="text-xs bg-gray-50 p-2 rounded max-h-16 overflow-y-auto font-mono">
                                ${result.system_prompt_text.substring(0, 200)}${result.system_prompt_text.length > 200 ? '...' : ''}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="text-sm font-medium text-gray-700 mb-2">Response:</div>
                            <div class="bg-gray-50 p-3 rounded max-h-64 overflow-y-auto whitespace-pre-wrap text-sm">
                                ${result.text}
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-500 border-t pt-2">
                            <div class="grid grid-cols-2 gap-2">
                                <div>Temperature: ${result.parameters_used?.temperature || 'N/A'}</div>
                                <div>Max Tokens: ${result.parameters_used?.max_tokens || 'N/A'}</div>
                                <div>Prompt Tokens: ${result.usage?.prompt_tokens || 0}</div>
                                <div>Completion Tokens: ${result.usage?.completion_tokens || 0}</div>
                            </div>
                        </div>
                    `;
                }

                resultsGrid.appendChild(card);
            });

            container.appendChild(resultsGrid);
        }

        function saveToHistory(testData) {
            const historyEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                userPrompt: testData.user_prompt,
                results: testData.results,
                successCount: testData.success_count,
                testCount: testData.test_count,
                model: testData.model
            };

            testHistory.unshift(historyEntry);

            // Keep only last 50 entries
            if (testHistory.length > 50) {
                testHistory = testHistory.slice(0, 50);
            }

            localStorage.setItem('testHistory', JSON.stringify(testHistory));
            loadHistory();
        }

        function loadHistory() {
            const container = document.getElementById('history-container');

            if (testHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📝</div>
                        <p>No test history yet. Run some tests to see results here.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            testHistory.forEach((entry, index) => {
                const historyCard = document.createElement('div');
                historyCard.className = 'bg-white border border-gray-200 rounded-lg p-4 card-hover';

                const timestamp = new Date(entry.timestamp).toLocaleString();
                const userPromptPreview = entry.userPrompt.length > 100
                    ? entry.userPrompt.substring(0, 100) + '...'
                    : entry.userPrompt;

                historyCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-semibold text-gray-800">Test #${testHistory.length - index}</h4>
                            <p class="text-sm text-gray-500">${timestamp}</p>
                        </div>
                        <div class="text-sm text-gray-600">
                            ${entry.successCount}/${entry.testCount} successful
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="text-xs text-gray-500 mb-1">User Prompt:</div>
                        <div class="text-sm bg-gray-50 p-2 rounded">${userPromptPreview}</div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-gray-500">
                            Model: ${entry.model} | ${Object.keys(entry.results).length} prompts tested
                        </div>
                        <button onclick="viewHistoryDetails(${entry.id})" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                            View Details
                        </button>
                    </div>
                `;

                container.appendChild(historyCard);
            });
        }

        function viewHistoryDetails(entryId) {
            const entry = testHistory.find(h => h.id === entryId);
            if (!entry) return;

            // Switch to testing tab and display the historical results
            showTab('testing');
            displayResults(entry);
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all test history?')) {
                testHistory = [];
                localStorage.removeItem('testHistory');
                loadHistory();
            }
        }

        // Module management functions
        function addModule() {
            const container = document.getElementById('modules-container');

            const modulePanel = document.createElement('div');
            modulePanel.className = 'module-panel';
            modulePanel.innerHTML = `
                <div class="module-header flex items-center justify-between p-3" onclick="toggleModule(this)">
                    <div class="flex items-center space-x-2">
                        <span class="drag-handle">⋮⋮</span>
                        <input type="text" class="module-name font-medium bg-transparent border-none focus:outline-none focus:bg-white focus:border focus:border-blue-500 rounded px-1" 
                               placeholder="MODULE_NAME" onclick="event.stopPropagation()">
                        <span class="text-sm text-gray-500 module-char-count">0 chars</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button type="button" onclick="event.stopPropagation(); removeModule(this)" 
                                class="text-red-600 hover:text-red-700 text-sm">Remove</button>
                        <span class="collapse-indicator">▼</span>
                    </div>
                </div>
                <div class="module-content p-3">
                    <textarea class="module-text w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono"
                              rows="6" placeholder="Module content..."></textarea>
                </div>
            `;

            container.appendChild(modulePanel);

            // Setup event listeners for the new module
            setupModuleEventListeners(modulePanel);
        }

        function setupModuleEventListeners(modulePanel) {
            const nameInput = modulePanel.querySelector('.module-name');
            const textArea = modulePanel.querySelector('.module-text');
            const charCount = modulePanel.querySelector('.module-char-count');

            textArea.addEventListener('input', function () {
                charCount.textContent = this.value.length + ' chars';
            });
        }

        function toggleModule(header) {
            const panel = header.parentElement;
            const indicator = header.querySelector('.collapse-indicator');

            panel.classList.toggle('collapsed');
            indicator.textContent = panel.classList.contains('collapsed') ? '▶' : '▼';
        }

        function removeModule(button) {
            const modulePanel = button.closest('.module-panel');
            modulePanel.remove();
        }

        function moveModule(button, direction) {
            const modulePanel = button.closest('.module-panel');
            const container = modulePanel.parentElement;

            if (direction === 'up' && modulePanel.previousElementSibling) {
                container.insertBefore(modulePanel, modulePanel.previousElementSibling);
            } else if (direction === 'down' && modulePanel.nextElementSibling) {
                container.insertBefore(modulePanel.nextElementSibling, modulePanel);
            }
        }

        function collectModuleData() {
            const modules = {};
            const order = [];

            document.querySelectorAll('.module-panel').forEach(panel => {
                const nameInput = panel.querySelector('.module-name');
                const textArea = panel.querySelector('.module-text');

                const name = nameInput.value.trim().toUpperCase();
                const text = textArea.value.trim();

                if (name && text) {
                    modules[name] = text;
                    order.push(name);
                }
            });

            return { modules, order };
        }

        function loadModulesIntoEditor(modules, order) {
            const container = document.getElementById('modules-container');
            container.innerHTML = '';

            const moduleOrder = order || Object.keys(modules);

            moduleOrder.forEach(moduleName => {
                const moduleText = modules[moduleName] || '';
                addModule();

                const lastPanel = container.lastElementChild;
                const nameInput = lastPanel.querySelector('.module-name');
                const textArea = lastPanel.querySelector('.module-text');
                const charCount = lastPanel.querySelector('.module-char-count');

                nameInput.value = moduleName;
                textArea.value = moduleText;
                charCount.textContent = moduleText.length + ' chars';
            });
        }

        async function savePrompt(event) {
            event.preventDefault();

            const editId = document.getElementById('edit-prompt-id').value;
            const id = document.getElementById('prompt-id').value.trim();
            const name = document.getElementById('prompt-name').value.trim();
            const description = document.getElementById('prompt-description').value.trim();

            const { modules, order } = collectModuleData();

            if (!id || !name || Object.keys(modules).length === 0) {
                showError('Please fill in all required fields and add at least one module');
                return;
            }

            const data = { id, name, description, modules, order };

            try {
                let response;
                if (editId) {
                    // Update existing prompt
                    response = await fetch(`${API_BASE}/system-prompts/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new prompt
                    response = await fetch(`${API_BASE}/system-prompts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    showSuccess(editId ? 'Prompt updated successfully!' : 'Prompt created successfully!');
                    clearForm();
                    loadSystemPrompts();
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to save prompt');
                }
            } catch (error) {
                showError('Error saving prompt: ' + error.message);
            }
        }

        function editPrompt(id) {
            const prompt = systemPrompts[id];
            if (!prompt) return;

            document.getElementById('edit-prompt-id').value = id;
            document.getElementById('prompt-id').value = id;
            document.getElementById('prompt-id').readOnly = true;
            document.getElementById('prompt-name').value = prompt.name;
            document.getElementById('prompt-description').value = prompt.description || '';

            loadModulesIntoEditor(prompt.modules || {}, prompt.order || []);

            showTab('management');
        }

        async function deletePrompt(id) {
            if (!confirm(`Are you sure you want to delete the prompt "${systemPrompts[id].name}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/system-prompts/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showSuccess('Prompt deleted successfully!');
                    loadSystemPrompts();
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to delete prompt');
                }
            } catch (error) {
                showError('Error deleting prompt: ' + error.message);
            }
        }

        async function duplicatePrompt(id) {
            const prompt = systemPrompts[id];
            if (!prompt) return;

            const newName = window.prompt(`Enter a name for the duplicated prompt:`, `${prompt.name} (Copy)`);
            if (!newName) return;

            try {
                const response = await fetch(`${API_BASE}/system-prompts/${id}/duplicate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });

                if (response.ok) {
                    showSuccess('Prompt duplicated successfully!');
                    loadSystemPrompts();
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to duplicate prompt');
                }
            } catch (error) {
                showError('Error duplicating prompt: ' + error.message);
            }
        }

        function clearForm() {
            document.getElementById('edit-prompt-id').value = '';
            document.getElementById('prompt-id').value = '';
            document.getElementById('prompt-id').readOnly = false;
            document.getElementById('prompt-name').value = '';
            document.getElementById('prompt-description').value = '';
            document.getElementById('modules-container').innerHTML = '';
        }

        function showTab(tabName) {
            // Hide all panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                tab.classList.remove('bg-white', 'bg-opacity-30');
                tab.classList.add('bg-white', 'bg-opacity-20');
            });

            // Show selected panel
            document.getElementById(`${tabName}-panel`).classList.remove('hidden');

            // Add active class to selected tab
            document.getElementById(`${tabName}-tab`).classList.remove('bg-opacity-20');
            document.getElementById(`${tabName}-tab`).classList.add('bg-opacity-30');
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            alert('Success: ' + message);
        }
    </script>
</body>

</html>